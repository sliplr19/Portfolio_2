---
title: "Schizophrenia Spectrum Disorder Networks"
author: "Lindley Slipetz"
date: "2/16/2021"
output: html_document
---

The purpose of this project is to compare the positive and negative symptom networks of schizophrenia spectrum disorders, particularly schizophrenia and schizoaffective disorder. We will be using three datasets from [SchizConnect](http://schizconnect.org/). We'll start by loading packages and data. I want to use the new EGAnet so I get pretty graphs, so I'll start by installing that.

```{r update_EGA}
#detach(package:EGAnet, unload = TRUE)
#install.packages("EGAnet")
```

Now I'm going to load all of these packages.

```{r packages, message = FALSE, warning = FALSE}
library(tidyverse)
library(polycor)
library(EGAnet)
```

Here's the data!

```{r data_load, message = FALSE, warning = FALSE}
fBIRN <- read.csv("G:\\My Drive\\DataScience\\Schizophrenia_data\\fBIRN.csv", header = TRUE)
NMorph <- read.csv("G:\\My Drive\\DataScience\\Schizophrenia_data\\NMorph.csv", header = TRUE)
NUSDAST <- read.csv("G:\\My Drive\\DataScience\\Schizophrenia_data\\NUSDAST.csv", header = TRUE)
```

This data is super messy: it's in long form and the variable names don't match. We have a lot of work to do! Before we put it into wide form, we'll need to limit the data to a particular time point for NMorph and NUSDAST.

```{r time}
NMorph <- NMorph %>%
  filter(visit == 0)
NUSDAST <- NUSDAST %>%
  filter(visit == 0)
```

Next, we'll subset the data to just the data we're interested in so we don't end up with a million columns when we turn the data wide.

```{r subset}
subset_fBIRN <- subset(fBIRN, (assessment_description == "Scale for the Assessment of Negative Symptoms" | assessment_description == "Scale for the Assessment of Positive Symptoms") | question_id %in% c("SCID_P47", "SCID_P48", "SCID_P53", "SCID_P54"))
subset_NMorph <- subset(NMorph, (assessment_description == "Scale for the Assessment of Negative Symptoms" | assessment_description == "Scale for the Assessment of Positive Symptoms") | question_id %in% c("scidp47_c", "scidp53_c"))
subset_NUSDAST <- subset(NUSDAST, (assessment_description == "Scale for the Assessment of Negative Symptoms" | assessment_description == "Scale for the Assessment of Positive Symptoms") | question_id %in% c("scidp47", "scidp53"))
```

We have a bunch of columns that we don't need. Let's get rid of those before going wide.

```{r del_col}
fBIRN_col <- subset(subset_fBIRN, select = -c(source, site, visit, assessment,
                                       assessment_description))
NMorph_col <- subset(subset_NMorph, select = -c(source, site, visit, assessment,
                                       assessment_description))
NUSDAST_col <- subset(subset_NUSDAST, select = -c(source, site, visit, assessment,
                                       assessment_description))
```

Now we can make the datasets wide! 

```{r data_wide, warning = FALSE}
fBIRN.wide <- reshape(fBIRN_col, timevar = "question_id", 
             idvar = c("subjectid", "study"), direction = "wide")
NMorph.wide <- reshape(NMorph_col, timevar = "question_id", 
             idvar = c("subjectid", "study"), direction = "wide")
NUSDAST.wide <- reshape(NUSDAST_col, timevar = "question_id", 
             idvar = c("subjectid", "study"), direction = "wide")
```



Let's rename the columns we want to work with before cutting columns again. For fBIRN, we're looking for the Scale for the Assessment of Negative Symptoms (SANS) and Scale for the Assessment of Positive Symptoms (SAPS) data. When I first did this project, Veronica matched the variable name to the name in the actual measure, but I've coded it. fBIRN is the only anomaly, so we'll just be renaming those SANS/SAPS columns to match the NMorph and NUSDAST datasets. The NMorph and NUSDAST just have weird columns names after the "widening", so we'll be deleting the "question_value." suffix from those datasets.

```{r fBIRN_rename}
names(fBIRN.wide) <- gsub(pattern = "question_value.", replacement = "", x = names(fBIRN.wide))
fBIRN_rename <- fBIRN_wide %>%
  rename(sans1 = 'Unchanging Facial Expression',
         sans2 = SS12, 
         sans3 = SS13, 
         sans4 = SS14, 
         sans5 = SS15, 
         sans7 = SS16, 
         sans8 = SS17, 
         sans6 = SS18, 
         sans9 = SS19, 
         sans10 = SS20,  
         sans11 = SS21,  
         sans12 = SS22, 
         sans13 = SS23,  
         sans14 = SS24, 
         sans15 = SS25,  
         sans16 = SS26,  
         sans17 = SS27,  
         sans18 = SS28,  
         sans19 = SS29, 
         sans20 = SS30, 
         sans21 = SS31,  
         sans22 = SS32,  
         sans23 = SS33,  
         sans24 = SS34,  
         sans25 = SS35,    
         saps1 = SS36,  
         saps2 = SS37,  
         saps3 = SS38,  
         saps4 = SS39, 
         saps5 = SS40, 
         saps6 = SS41,  
         saps7 = SS42,  
         saps8 = SS43,  
         saps9 = SS44,  
         saps10 = SS45, 
         saps11 = SS46,  
         saps12 = SS47,  
         saps13 = SS48,  
         saps14 = SS49, 
         saps15 = SS50, 
         saps16 = SS51,  
         saps17 = SS52,  
         saps18 = SS53,  
         saps19 = SS54,  
         saps20 = SS55, 
         saps21 = SS56,  
         saps22 = SS57,  
         saps23 = SS58,  
         saps24 = SS59, 
         saps25 = SS60, 
         saps26 = SS61,  
         saps27 = SS62,  
         saps28 = SS63,  
         saps29 = SS64,  
         saps30 = SS65, 
         saps31 = SS66,  
         saps32 = SS67,  
         saps33 = SS68,  
         saps34 = SS69)
names(NMorph.wide) <- gsub(pattern = "question_value.", replacement = "", x = names(NMorph.wide))
names(NUSDAST.wide) <- gsub(pattern = "question_value.", replacement = "", x = names(NUSDAST.wide))
```

Now we're going to make a new column for each data frame, 'SSD'. This will tell if someone has a diagnosis of schizophrenia, schizoaffective or other.

```{r SSD}
fBIRN_complete <- fBIRN_rename %>%
  mutate(
    SSD = case_when(
      SCID_P48 == 3 | SCID_P47 == 3 ~ "Schizophrenia",
      SCID_P54 == 3 | SCID_P53 == 3 ~ "Schizoaffective",
      TRUE                          ~ "Other"
    )
  ) 
NMorph_complete <- NMorph.wide %>%
  mutate(
    SSD = case_when(
      scidp47_c == 3 ~ "Schizophrenia",
      scidp53_c == 3 ~ "Schizoaffective",
      TRUE                          ~ "Other"
    )
  )  
NUSDAST_complete <- NUSDAST.wide %>%
  mutate(
    SSD = case_when(
      scidp47 == 3 ~ "Schizophrenia",
      scidp53 == 3 ~ "Schizoaffective",
      TRUE                          ~ "Other"
    )
  )  
```

Okay, now we have all the information we need. Now we just need to delete the subjectid, study, and non-SSD diagnosis columns. Then we can join all the datasets together. The column with a space in fBIRN ("Proband Interview") was giving me problems so I deleted that separately.

```{r del_col_2}
fBIRN_complete$"Proband Interview" <- NULL
fBIRN_complete <- subset(fBIRN_complete, select = -c(subjectid, study, SCID_P53, SCID_P47, SCID_P48, SCID_P54, Family, Friends, Medication, Other, Staff, Status, SS3, SS4, Reliability))
NMorph_complete <- subset(NMorph_complete, select = -c(study, subjectid, scidp47_c, scidp53_c))     
NUSDAST_complete <- subset(NUSDAST_complete, select = -c(study, subjectid, scidp47, scidp53))                         
```

Okay, now what we've been waiting for: we're going to make one giant dataset (okay, maybe that's not what we've been waiting for, but it's an exciting step).

```{r bind}
data_complete <- rbind(fBIRN_complete, NMorph_complete, NUSDAST_complete)
```

So you probably think our data is ready now, but there's just one last thing we need to do. The SANS and SAPS use summary scores in the measure. We just want the item level data, not the global scores. Let's delete the global scores.

```{r global}
data_complete <- subset(data_complete, select = -c(sans8, sans13, sans17, sans22, sans25, saps7, saps20, saps25, saps34))
```
Finally! We have our data tidy. Now we can start analyzing it. When I used this data for my first year project, I used only the sans data. I found that there were two factors for both schizophrenia and schizoaffective: psychomotor poverty and anhedonia. Now we're going to do EGA to see the factors of both SANS and SAPS. We'll start with polychoric correlations because the data is ordinal.

```{r all_corr}
data_complete <- data.frame(matrix(unlist(data_complete), nrow=nrow(data_complete)),stringsAsFactors=FALSE)
all_corr <- polycor::hetcor(data_complete[,c(1:50)])
```
